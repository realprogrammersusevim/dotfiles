#!luajit

local toml = require('toml')
local argparse = require('argparse')

local parser = argparse()({ name = 'dotfiles', description = 'Manage dotfiles' })
parser:argument('action', 'The action to take.'):choices({ 'pull', 'push' }):default('pull')
parser:option('-c --config', 'The config file to use.'):default('config.toml')
parser:flag('-d --delete', 'Sync deletions.')
parser:flag('-v --verbose', 'Verbose output.')
local args = parser:parse()

local function log(logee)
  if args.verbose then
    print(logee)
  end
end

local config_text = io.open(args.config, 'r'):read('a')
local config = toml.parse(config_text)

local repo_loc = config.dotfiles
if repo_loc:sub(-1) ~= '/' then
  repo_loc = repo_loc .. '/'
end

local function command(name, recursive, sources, destination)
  log(name .. ' ...')
  for _, source in ipairs(sources) do
    local cmd = 'rsync --no-perms --no-owner --no-group '
    if recursive then
      cmd = cmd .. '-r '
    end
    if args.delete then
      cmd = cmd .. '--delete '
    end
    if args.verbose then
      cmd = cmd .. '-v '
    end
    cmd = cmd .. source .. ' ' .. repo_loc .. destination
    log('Running command: ' .. cmd)
    os.execute(cmd)
  end
end

if args.action == 'pull' then
  log('Syncing local dotfile changes into this repo...')
  command('Kitty', false, { config.kitty }, 'kitty/')

  command('Neovim', true, { config.nvim }, 'nvim/')

  command('Zsh', false, config.zsh, 'zsh/')
elseif args.action == 'push' then
  log('Syncing repo dotfile changes into local...')
  log('Kitty...')
  local kitty_command = 'rsync --no-perms --no-owner --no-group '
    .. repo_loc
    .. 'kitty/* '
    .. config.kitty
  log(kitty_command)
  os.execute(kitty_command)

  log('Neovim...')
  local nvim_command = 'rsync -r --no-perms --no-owner --no-group '
    .. repo_loc
    .. 'nvim/* '
    .. config.neovim
  if args.delete then
    nvim_command = nvim_command .. ' --delete'
  end
  log(nvim_command)
  os.execute(nvim_command)

  log('Zsh...')
  for _, file in ipairs(config.zsh) do
    local zsh_commmand = 'rsync --no-perms --no-owner --no-group ' .. repo_loc .. 'zsh/* ' .. file
    log(zsh_commmand)
    os.execute(zsh_commmand)
  end
end
